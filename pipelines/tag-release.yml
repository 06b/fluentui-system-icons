# Copyright (c) Microsoft Corporation.
# Licensed under the MIT license.

steps:
- checkout: self
  clean: true
  persistCredentials: true

- task: Bash@3
  displayName: Checkout the master branch
  inputs:
    targetType: 'inline'
    script: 'git checkout master --'

# Needs to be "-E" instead of "-r" on macOS
- bash: |
    sed -i.bk -r "s/[0-9]+\.[0-9]+\.[0-9]+/$(Build.BuildNumber)/g" $(System.DefaultWorkingDirectory)/README.md
    rm $(System.DefaultWorkingDirectory)/README.md.bk
  displayName: Replace version numbers in README.md

# Needs to be "-E" instead of "-r" on macOS
- bash: |
    sed -i.bk -r "s/[0-9]+\.[0-9]+\.[0-9]+/$(Build.BuildNumber)/g" $(System.DefaultWorkingDirectory)/ios/README.md
    rm $(System.DefaultWorkingDirectory)/ios/README.md.bk
  displayName: Replace version numbers in ios/README.md

# Needs to be "-E" instead of "-r" on macOS
- bash: |
    sed -i.bk -r "s/[0-9]+\.[0-9]+\.[0-9]+/$(Build.BuildNumber)/g" $(System.DefaultWorkingDirectory)/ios/FluentIcons.podspec
    rm $(System.DefaultWorkingDirectory)/ios/FluentIcons.podspec.bk
  displayName: Replace version number in Podspec

- task: Bash@3
  displayName: Config git credentials
  inputs:
    targetType: 'inline'
    script: 'git config user.email "flubuild@microsoft.com" && git config user.name "Fluent Build System"'

- bash: |
    git add -A
    git commit -m 'Prepare release $(Build.BuildNumber)'
  displayName: Commit version number change

- task: Bash@3
  displayName: Push commit
  inputs:
    targetType: 'inline'
    script: git push https://Personal%20Access%20Token:${SECURE_PAT}@dev.azure.com/microsoftdesign/Design%20System/_git/fluent-mobile-icons master
  env:
    SECURE_PAT: $(PAT)

- bash: |
    git tag $(Build.BuildNumber)
  displayName: Tag release

- task: Bash@3
  displayName: Push tags
  inputs:
    targetType: 'inline'
    script: git push https://Personal%20Access%20Token:${SECURE_PAT}@dev.azure.com/microsoftdesign/Design%20System/_git/fluent-mobile-icons --tags
  env:
    SECURE_PAT: $(PAT)
